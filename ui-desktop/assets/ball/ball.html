<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ZCAM Ball</title>
  <style>
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; width:100%; height:100%; background:transparent; }
    body { display:flex; align-items:center; justify-content:center; -webkit-app-region:drag; user-select:none; }
    #ball-root { width:100%; height:100%; display:flex; align-items:center; justify-content:center; }
    .ball-box { width:72px; height:72px; border-radius:50%; background:linear-gradient(135deg,#1f1f1f,#2a2a2a); border:1px solid rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center; box-shadow:0 8px 16px rgba(0,0,0,0.5),0 2px 4px rgba(0,0,0,0.4); cursor:pointer; -webkit-app-region:no-drag; }
    .ball-box img { width:56px; height:56px; border-radius:12px; pointer-events:none; }
  </style>
</head>
<body>
  <div id="ball-root">
    <div class="ball-box" ondblclick="window.electronAPI?.restoreFromBall?.()">
      <img src="../logo.png" alt="ZCAM" draggable="false" />
    </div>
  </div>
  <script>
    (() => {
      // 验证 preload 注入
      if (!window.electronAPI) {
        console.error('[BallClient] electronAPI not found');
        window.electronAPI = { devReport: () => {}, onDevCommand: () => (() => {}) };
      } else {
        console.log('[BallClient] electronAPI OK');
      }

      // 实现 DevChannelImpl 就地
      class DevChannelImpl {
        constructor() {
          this.listeners = new Set();
          const unsub = window.electronAPI.onDevCommand((cmd) => {
            this.listeners.forEach(cb => cb(cmd));
          });
          this.unsub = unsub;
        }
        report(report) {
          window.electronAPI.devReport(report);
        }
        onCommand(cb) {
          this.listeners.add(cb);
          return () => {
            this.listeners.delete(cb);
            if (this.listeners.size === 0) {
              this.unsub?.();
              this.unsub = undefined;
            }
          };
        }
      }

      // 实现 BallClient 就地
      class BallClient {
        constructor() {
          this.dev = new DevChannelImpl();
          this.root = null;
          this.unsub = null;
        }
        mount(root) {
          this.root = root;
          this.report('mounted');
          root.addEventListener('click', () => this.report('interaction', { event: 'click' }));
          this.unsub = this.dev.onCommand((cmd) => {
            if (cmd.cmd === 'ping') this.report('interaction', { event: 'pong' });
            if (cmd.cmd === 'measure') this.reportMeasure();
            if (cmd.cmd === 'highlight') this.highlight();
          });
        }
        unmount() {
          this.report('unmounted');
          this.unsub?.();
          this.root = null;
        }
        reportMeasure() {
          if (!this.root) return;
          const rect = this.root.getBoundingClientRect();
          const scrollInfo = {
            hasHorizontalScrollbar: this.root.scrollWidth > this.root.clientWidth,
            hasVerticalScrollbar: this.root.scrollHeight > this.root.clientHeight,
            scrollWidth: this.root.scrollWidth,
            scrollHeight: this.root.scrollHeight,
            clientWidth: this.root.clientWidth,
            clientHeight: this.root.clientHeight,
          };
          this.dev.report({
            type: 'updated',
            controlId: 'ball',
            ts: Date.now(),
            rect,
            scrollInfo,
          });
        }
        highlight() {
          if (!this.root) return;
          this.root.style.outline = '2px dashed red';
          setTimeout(() => {
            if (this.root) this.root.style.outline = '';
          }, 2000);
        }
        report(type, extra) {
          if (!this.root) return;
          const payload = {
            type,
            controlId: 'ball',
            ts: Date.now(),
            ...extra,
          };
          if (type === 'mounted' || type === 'updated') {
            payload.rect = this.root.getBoundingClientRect();
            payload.scrollInfo = {
              hasHorizontalScrollbar: this.root.scrollWidth > this.root.clientWidth,
              hasVerticalScrollbar: this.root.scrollHeight > this.root.clientHeight,
              scrollWidth: this.root.scrollWidth,
              scrollHeight: this.root.scrollHeight,
              clientWidth: this.root.clientWidth,
              clientHeight: this.root.clientHeight,
            };
          }
          this.dev.report(payload);
        }
      }

      // 挂载 BallClient
      const rootEl = document.getElementById('ball-root');
      if (rootEl) {
        const client = new BallClient();
        client.mount(rootEl);
        console.log('[BallClient] mounted and reported');
      } else {
        console.error('[BallClient] ball-root not found');
      }
    })();
  </script>
</body>
</html>
